"use client"

import { Loader2 } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Separator } from "@/components/ui/separator"
import { useData } from "@/providers/data-provider"
import { useForm } from "react-hook-form"
import { useCallback, useRef, useEffect } from "react"
import { useToast } from "@/components/ui/use-toast"
import { TextEditor } from "@/components/shared/text-editor"


export function VulnerabilityImpact({ vulnerabilityId }) {
    const { vulnerabilities, setVulnerabilities, loadingVulnerabilities } = useData()

    const vulnerability = vulnerabilities.filter((vulnerability) => vulnerability._id == vulnerabilityId)[0]
    
    const impact  = useRef(null)
    const {toast} = useToast()


    const submit = useCallback(async () => {
        const editor = impact.current;

        // Handle the case where editor is null
        if (editor) {

            const res = await fetch(`/api/vulnerabilities/${vulnerabilityId}`, { 
                method: "POST",
                body: JSON.stringify({impact: editor.children})
            }) 
            
            const data = await res.json()
            let updatedVulnerabilities = [...vulnerabilities]
            updatedVulnerabilities[vulnerabilities.findIndex(vulnerability => vulnerability._id === vulnerabilityId)] = data

            setVulnerabilities(updatedVulnerabilities)
            toast({ description: `Vulnerability "${data.vulnerabilityIdentifier}" has been updated successfully.` })
        }
    }, []);

    useEffect(() => {
        const down = (e) => {
            if (e.key === "s" && (e.metaKey || e.ctrlKey)) {
                e.preventDefault()
                submit()
            }
        }

        document.addEventListener("keydown", down)
        return () => document.removeEventListener("keydown", down)
    }, [])

    return (
        <div className="space-y-6 h-full">
            <div className="flex flex-row justify-between items-center">
                <div>
                    <h3 className="text-lg font-medium">Impact</h3>
                    <p className="text-sm text-muted-foreground">
                        Explain the impact of a vulnerability using the text editor below.
                    </p>
                </div>
                <div>
                    <Button onClick={() => { form.handleSubmit(onSubmit)() }}>Save (ctrl+s)</Button>
                </div>
            </div>
            <Separator />
        {!loadingVulnerabilities && vulnerability?.impact ? (
            <TextEditor initialValue={JSON.parse(vulnerability?.impact)} editorRef={impact}/>
        ) : (
            <span className="w-full flex items-center justify-center pt-6"><Loader2 className="h-8 w-8 animate-spin" /></span>
        )}
        <p></p>
        </div>
    )
}